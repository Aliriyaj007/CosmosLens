<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CosmosLens Ultimate | Aliriyaj007</title>
    <style>
        :root {
            --bg-deep: #020204;
            --glass: rgba(10, 20, 35, 0.9);
            --border: rgba(100, 220, 255, 0.15);
            --accent: #00F0FF;
            --accent-glow: rgba(0, 240, 255, 0.3);
            --text-main: #EAEAEA;
            --text-sub: #8899AA;
            --font-ui: 'Segoe UI', Roboto, Helvetica, sans-serif;
            --warning: #ff9d00;
            --success: #00ff9d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        /* --- TEACHER MODE UI HIDING --- */
        body.teacher-mode .btn-fancy { display: none !important; }
        body.teacher-mode #audio-btn { display: none !important; }

        canvas { display: block; width: 100%; height: 100%; cursor: move; touch-action: none; }

        /* --- UI CONTAINER --- */
        .hud {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        .interactive { pointer-events: auto; }

        /* --- TOP HEADER --- */
        .header {
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: flex-start;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }

        .brand h1 {
            font-size: 1.1rem; letter-spacing: 3px; text-transform: uppercase; margin: 0;
            text-shadow: 0 0 15px var(--accent-glow); color: var(--accent);
            display: flex; align-items: center; gap: 10px;
        }
        .brand .breadcrumbs { font-size: 0.75rem; color: var(--text-sub); margin-top: 5px; cursor: pointer; }
        .breadcrumbs span { color: var(--accent); text-decoration: underline; cursor: pointer; }

        /* --- CONTROL PANELS --- */
        .control-group {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column; gap: 8px;
        }
        .top-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        
        .btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            color: var(--text-sub); padding: 5px 10px; border-radius: 4px;
            font-size: 0.7rem; cursor: pointer; transition: 0.2s;
            text-transform: uppercase; letter-spacing: 0.5px; text-align: center;
        }
        .btn:hover, .btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0, 240, 255, 0.05); }
        .btn.active { box-shadow: 0 0 10px var(--accent-glow); }
        .btn-icon { width: 28px; height: 28px; padding: 0; display: grid; place-items: center; font-size: 1rem; }

        /* New Controls */
        .system-select, .mode-select {
            background: #111; color: white; border: 1px solid var(--border);
            padding: 5px; border-radius: 4px; font-size: 0.7rem; font-family: var(--font-ui);
        }
        
        .time-control {
            display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.5);
            padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border);
        }
        .time-label { font-size: 0.6rem; color: var(--text-sub); text-transform: uppercase; font-weight: bold; }
        input[type=range] {
            width: 100px; -webkit-appearance: none; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 10px; width: 10px; border-radius: 50%;
            background: var(--accent); cursor: pointer; margin-top: -4px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; cursor: pointer; background: #444;
        }

        /* --- SIDEBAR INFO --- */
        .info-sidebar {
            position: absolute; top: 0; right: 0; bottom: 0;
            width: 320px;
            background: rgba(2, 5, 10, 0.98);
            border-left: 1px solid var(--border);
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 0; display: flex; flex-direction: column;
            box-shadow: -15px 0 50px rgba(0,0,0,0.8);
            pointer-events: auto;
            z-index: 20;
        }
        .info-sidebar.active { transform: translateX(0); }
        .info-content { padding: 20px; overflow-y: auto; flex: 1; padding-bottom: 100px;}
        .planet-hero {
            font-size: 2rem; font-weight: 300; margin: 0 0 5px 0;
            background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .planet-sub { font-size: 0.8rem; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; }
        .stat-item h4 { font-size: 0.65rem; color: var(--text-sub); margin: 0 0 4px 0; text-transform: uppercase; }
        .stat-item p { font-size: 0.85rem; margin: 0; font-weight: 600; color: #fff; }
        .close-info { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; transition: 0.2s; z-index: 2; }
        .close-info:hover { color: white; }

        /* --- GRAVITY JUMP LAB (Sidebar) --- */
        .gravity-lab {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            border-radius: 8px; margin-top: 20px; overflow: hidden;
            text-align: center;
        }
        .lab-header { padding: 10px; background: rgba(255,255,255,0.05); font-size: 0.75rem; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        .lab-canvas-container { width: 100%; height: 100px; position: relative; background: linear-gradient(to bottom, #111, #000); }
        #jump-canvas { width: 100%; height: 100%; }
        .lab-controls { padding: 10px; display: flex; gap: 5px; justify-content: center;}
        .lab-btn { background: #333; border: none; color: white; font-size: 0.7rem; padding: 4px 8px; border-radius: 3px; cursor: pointer; }
        .lab-btn:hover { background: var(--accent); color: black; }
        .lab-readout { font-size: 0.7rem; color: #aaa; margin-top: 5px; font-family: monospace; }

        /* --- ATMOSPHERIC OVERLAY --- */
        #atmos-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; mix-blend-mode: overlay; opacity: 0; transition: opacity 1s ease; }
        
        /* --- BOTTOM DOCK --- */
        .bottom-dock { padding: 10px 20px; background: linear-gradient(to top, rgba(0,0,0,1), transparent); }
        .nav-rail { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .nav-chip {
            background: var(--glass); border: 1px solid var(--border);
            padding: 6px 14px; border-radius: 20px; color: var(--text-sub);
            font-size: 0.8rem; white-space: nowrap; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .nav-chip:hover, .nav-chip.active {
            border-color: var(--accent); color: white; box-shadow: 0 0 15px rgba(0, 240, 255, 0.15); background: rgba(0, 240, 255, 0.1);
        }
        .color-dot { width: 8px; height: 8px; border-radius: 50%; }
        .astro-marker {
            position: absolute; width: 10px; height: 10px; background: white;
            border-radius: 50%; pointer-events: none; z-index: 15;
            box-shadow: 0 0 10px white; transform: translate(-50%, -50%);
            display: none;
        }

        /* --- UPGRADED LAB STYLES (Untouched) --- */
        #lab-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050508; z-index: 30;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none; transition: opacity 0.4s;
        }
        #lab-overlay.active { opacity: 1; pointer-events: auto; }

        .lab-header {
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #222;
            background: #08080c;
        }
        .lab-title { color: var(--accent); text-transform: uppercase; letter-spacing: 4px; font-weight: 700; }
        
        .lab-controls { display: flex; gap: 10px; }
        .mode-toggle { display: flex; background: #111; border-radius: 4px; padding: 2px; }
        .mode-btn {
            background: transparent; border: none; color: #666; padding: 5px 10px;
            font-size: 0.75rem; cursor: pointer; text-transform: uppercase;
        }
        .mode-btn.active { background: var(--accent); color: black; font-weight: bold; }

        .lab-container { flex: 1; display: flex; overflow: hidden; flex-direction: row; }
        .lab-stage { flex: 2; display: flex; position: relative; }
        .lab-viewport {
            flex: 1; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-right: 1px solid #111; overflow: hidden;
        }
        .lab-viewport:last-child { border-right: none; }
        
        .lab-canvas-wrapper {
            position: relative; width: 100%; height: 100%; cursor: grab;
        }
        .lab-canvas-wrapper:active { cursor: grabbing; }
        
        canvas.lab-canvas { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .lab-select-wrap {
            position: absolute; top: 15px; z-index: 10;
            background: rgba(0,0,0,0.8); padding: 5px; border-radius: 4px; border: 1px solid #333;
        }
        .lab-select { background: #222; color: white; border: none; padding: 5px; border-radius: 2px; font-family: var(--font-ui); font-size: 0.85rem; }

        .lab-stats-panel {
            flex: 1; background: #08080c; border-left: 1px solid #222;
            padding: 20px; overflow-y: auto; min-width: 300px;
        }
        .stat-card { background: rgba(255,255,255,0.03); border-radius: 6px; padding: 15px; margin-bottom: 15px; }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 0.8rem; color: #666; text-transform: uppercase; }
        
        .stat-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .stat-label { width: 60px; color: #888; }
        .stat-bar-container { flex: 1; height: 6px; background: #222; border-radius: 3px; margin: 0 10px; overflow: hidden; }
        .stat-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .stat-val { width: 50px; text-align: right; color: white; font-family: monospace; }

        @media (max-width: 768px) {
            .lab-container { flex-direction: column; }
            .lab-stats-panel { min-width: 100%; height: 40%; border-left: none; border-top: 1px solid #222; }
            .lab-stage { height: 60%; flex-direction: column; }
            .lab-viewport { border-right: none; border-bottom: 1px solid #111; }
        }

        /* --- MODALS & ONBOARDING --- */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 100; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-card {
            background: #0a0f16; border: 1px solid var(--border);
            width: 90%; max-width: 500px; padding: 25px; border-radius: 12px;
            box-shadow: 0 0 30px rgba(0,240,255,0.1); color: #ddd;
        }
        .modal-card h2 { color: var(--accent); margin-top: 0; text-transform: uppercase; letter-spacing: 2px; }
        .modal-card ul { line-height: 1.6; padding-left: 20px; color: #bbb; }
        .modal-btn { background: var(--accent); color: black; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; float: right; margin-top: 15px; }
        .modal-btn:hover { box-shadow: 0 0 10px var(--accent); }

        /* Onboarding specific */
        .onboarding-step { text-align: center; }
        .step-indicator { font-size: 3rem; color: rgba(255,255,255,0.1); margin-bottom: 10px; font-weight: bold; }
        .highlight-box { border: 1px solid var(--accent); background: rgba(0, 240, 255, 0.1); padding: 5px; border-radius: 4px; display: inline-block; color: var(--accent); font-weight: bold; }

        /* Footer Credit */
        .footer-credit {
            position: absolute; bottom: 10px; right: 15px;
            font-size: 0.6rem; color: rgba(255,255,255,0.2);
            pointer-events: none; z-index: 5;
        }
    </style>
</head>
<body>

    <!-- AUDIO TOGGLE -->
    <div style="position:absolute; top: 10px; right: 10px; z-index: 9;">
        <button class="btn btn-icon" id="audio-btn" onclick="audioManager.toggle()">üîá</button>
    </div>

    <!-- ATMOSPHERIC OVERLAY -->
    <div id="atmos-overlay"></div>
    <div id="astro-marker" class="astro-marker"></div>

    <!-- ONBOARDING MODAL -->
    <div id="onboarding" class="modal-overlay">
        <div class="modal-card onboarding-step">
            <div class="step-indicator" id="ob-step-num">1/3</div>
            <h2 id="ob-title">Welcome, Explorer</h2>
            <p id="ob-desc">Welcome to CosmosLens. This is a fully interactive 3D simulation of our solar system running entirely in your browser.</p>
            <div style="margin-top:20px;">
                <button class="btn" style="float:left; background:transparent; border:1px solid #444;" onclick="onboarding.close()">Skip</button>
                <button class="modal-btn" onclick="onboarding.next()">Next</button>
                <div style="clear:both;"></div>
            </div>
        </div>
    </div>

    <!-- USER GUIDE MODAL -->
    <div id="guide-modal" class="modal-overlay">
        <div class="modal-card">
            <h2>Commander's Guide</h2>
            <p>Master the tools of the CosmosLens:</p>
            <ul>
                <li><strong>Navigate:</strong> Drag to rotate view. Scroll to zoom. Click planets in bottom rail or sidebar.</li>
                <li><strong>Time Warp:</strong> Use slider to speed up, reverse, or pause orbital mechanics.</li>
                <li><strong>Teacher Mode:</strong> Toggle to enable Orbit Trails and simplify UI for educational demonstrations.</li>
                <li><strong>Systems:</strong> Switch between the Solar System and the Trappist-1 Exoplanet System.</li>
                <li><strong>Lab Mode:</strong> Compare any two celestial bodies. Use "Stack" mode to see size differences (e.g., Earth vs Jupiter).</li>
            </ul>
            <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 10px; font-size: 0.8rem; color: var(--accent);">
                Made with ‚ù§Ô∏è by Aliriyaj007
            </div>
            <button class="modal-btn" onclick="document.getElementById('guide-modal').classList.remove('active')">Understood</button>
        </div>
    </div>

    <!-- UPGRADED LAB OVERLAY -->
    <div id="lab-overlay">
        <div class="lab-header">
            <span class="lab-title">Comparison Lab</span>
            <div class="lab-controls">
                <div class="mode-toggle">
                    <button class="mode-btn active" id="mode-split" onclick="lab.setMode('split')">Side-by-Side</button>
                    <button class="mode-btn" id="mode-stack" onclick="lab.setMode('stack')">Overlay/Stack</button>
                </div>
                <button class="btn" style="margin-left:15px;" onclick="lab.toggle()">Exit</button>
            </div>
        </div>

        <div class="lab-container">
            <div class="lab-stage">
                <div class="lab-viewport">
                    <div class="lab-select-wrap">
                        <select id="lab-select-1" class="lab-select" onchange="lab.refresh()"></select>
                    </div>
                    <div class="lab-canvas-wrapper" id="wrapper-1">
                        <canvas id="lab-canvas-1" class="lab-canvas"></canvas>
                    </div>
                </div>
                <div class="lab-viewport">
                    <div class="lab-select-wrap">
                        <select id="lab-select-2" class="lab-select" onchange="lab.refresh()"></select>
                    </div>
                    <div class="lab-canvas-wrapper" id="wrapper-2">
                        <canvas id="lab-canvas-2" class="lab-canvas"></canvas>
                    </div>
                </div>
            </div>

            <div class="lab-stats-panel">
                <div class="stat-card">
                    <h3>Diameter Comparison</h3>
                    <div id="bar-dia" class="bar-container-inner"></div>
                </div>
                <div class="stat-card">
                    <h3>Surface Gravity (1g = Earth)</h3>
                    <div id="bar-grav" class="bar-container-inner"></div>
                </div>
                <div class="stat-card">
                    <h3>Mass Relative to Earth</h3>
                    <div id="bar-mass" class="bar-container-inner"></div>
                </div>
                <div class="stat-card" style="margin-top:auto">
                    <div style="font-size:0.8rem; color:#666; line-height:1.5">
                        <strong>Tip:</strong> Drag on canvas to rotate planets. Use "Overlay/Stack" to see how many Earths fit inside Jupiter.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN HUD -->
    <div class="hud">
        <div class="header">
            <div class="brand interactive">
                <button class="btn" onclick="ui.toggleSidebar()">‚ò∞ Data</button>
                <h1>CosmosLens</h1>
                <div class="breadcrumbs" id="breadcrumbs">Solar System</div>
            </div>
            
            <div class="control-group interactive top-controls">
                <!-- System & Mode Selectors -->
                <div style="display:flex; gap:5px; align-items:center;">
                    <select id="system-select" class="system-select" onchange="systemManager.load(this.value)">
                        <option value="solar">System: Solar</option>
                        <option value="trappist">System: Trappist-1</option>
                    </select>
                    <select id="mode-select" class="mode-select" onchange="sim.toggleTeacherMode(this.value)">
                        <option value="student">Mode: Student</option>
                        <option value="teacher">Mode: Teacher</option>
                    </select>
                </div>

                <div class="time-control">
                    <span class="time-label">Time</span>
                    <input type="range" id="time-slider" min="-100" max="200" value="20" step="5" oninput="sim.setTimeScale(this.value)">
                </div>

                <!-- Visual Toggles (Hidden in Teacher Mode via CSS) -->
                <div style="display:flex; gap:5px; flex-wrap: wrap; justify-content: flex-end;" class="btn-fancy">
                    <button class="btn" onclick="document.getElementById('guide-modal').classList.add('active')">Guide</button>
                    <button class="btn" id="btn-scale" onclick="sim.toggleScale()">Scale: Visual</button>
                    <button class="btn" id="btn-zone" onclick="sim.toggleGoldilocks()">Zone</button>
                    <button class="btn" id="btn-well" onclick="sim.toggleGravityWell()">Gravity Well</button>
                    <button class="btn" id="btn-probe" onclick="sim.toggleProbes()">Probes</button>
                    <button class="btn" id="btn-lab" onclick="lab.toggle()">Lab</button>
                </div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button class="btn btn-icon" onclick="cam.reset()" title="Reset">‚ü≤</button>
                    <button class="btn btn-icon" onclick="cam.zoomOut()" title="Zoom Out">-</button>
                    <button class="btn btn-icon" onclick="cam.zoomIn()" title="Zoom In">+</button>
                </div>
            </div>
        </div>

        <div class="bottom-dock interactive">
            <div class="nav-rail" id="nav-rail"></div>
        </div>
    </div>

    <!-- SIDEBAR -->
    <div class="info-sidebar interactive" id="sidebar">
        <button class="close-info" onclick="ui.closeSidebar()">√ó</button>
        <div class="info-content">
            <h2 class="planet-hero" id="info-name">Earth</h2>
            <div class="planet-sub" id="info-type">Terrestrial Planet</div>
            
            <div class="stat-grid" id="dynamic-stats">
                <!-- Dynamic -->
            </div>

            <div style="font-size:0.85rem; color:#bbb; line-height:1.5; margin-bottom:20px;" id="info-desc"></div>

            <div class="gravity-lab" id="gravity-lab-section">
                <div class="lab-header">
                    <span>Gravity Jump Lab</span>
                    <button class="lab-btn" onclick="gravityLab.run()">JUMP</button>
                </div>
                <div class="lab-canvas-container">
                    <canvas id="jump-canvas" width="280" height="100"></canvas>
                </div>
                <div class="lab-readout" id="jump-readout">Jump Height: 0.5m (Earth)</div>
                <div class="lab-controls">
                    <button class="lab-btn" onclick="gravityLab.select(cam.targetId)">Current</button>
                    <button class="lab-btn" onclick="gravityLab.select('sun')">Sun</button>
                    <button class="lab-btn" onclick="gravityLab.select('moon')">Moon</button>
                    <button class="lab-btn" onclick="gravityLab.select('jupiter')">Jupiter</button>
                </div>
            </div>

            <div id="action-area" style="margin-top:20px; border-top:1px solid #333; padding-top:15px;"></div>
        </div>
    </div>

    <!-- MAIN CANVAS -->
    <canvas id="cosmos"></canvas>
    
    <!-- FOOTER CREDIT -->
    <div class="footer-credit">Made with ‚ù§Ô∏è by Aliriyaj007</div>

<script>
/**
 * COSMOS LENS ULTIMATE (PATCHED UX & LOGIC)
 */

// --- 1. GLOBAL VARIABLES ---
let objects = {}; 
let particles = []; 
let probes = [];
let mainRAF = null;

// --- 2. DATA ---
const SOLAR_DATA = {
    sun: { id: 'sun', name: 'Sun', type: 'Yellow Dwarf', visualRadius: 40, realRadius: 45, color: '#FDB813', glow: '#FF8F00', texture: 'star', parent: null, orbit: { r: 0, speed: 0 }, stats: { dia: '1,392,700 km', day: '25 Days', temp: '5,500¬∞C', orb: 'N/A' }, atmos: { active: false, color: 'transparent', composition: 'Hydrogen/Helium Plasma' }, comp: { g: 27.94, mass: 333000, dia: 109 }, details: "The star at the center of the Solar System." },
    mercury: { id: 'mercury', name: 'Mercury', type: 'Terrestrial', visualRadius: 6, realRadius: 0.17, color: '#A5A5A5', texture: 'rocky', parent: 'sun', orbit: { r: 70, speed: 2.5, angle: Math.random()*6 }, stats: { dia: '4,879 km', day: '59 Days', temp: '167¬∞C', orb: '88 Days' }, atmos: { active: false, color: 'transparent', composition: 'Negligible' }, comp: { g: 0.38, mass: 0.055, dia: 0.38 }, details: "Smallest planet." },
    venus: { id: 'venus', name: 'Venus', type: 'Terrestrial', visualRadius: 9, realRadius: 0.42, color: '#E3BB76', texture: 'atmosphere', parent: 'sun', orbit: { r: 100, speed: 1.8, angle: Math.random()*6 }, stats: { dia: '12,104 km', day: '243 Days', temp: '464¬∞C', orb: '225 Days' }, atmos: { active: true, color: 'rgba(255, 160, 50, 0.4)', composition: '96.5% CO2, 3.5% Nitrogen' }, comp: { g: 0.904, mass: 0.815, dia: 0.95 }, details: "Hottest planet." },
    earth: { id: 'earth', name: 'Earth', type: 'Terrestrial', visualRadius: 9.5, realRadius: 0.45, color: '#22A6B3', texture: 'earth', parent: 'sun', orbit: { r: 140, speed: 1.2, angle: Math.random()*6 }, stats: { dia: '12,742 km', day: '24 Hours', temp: '15¬∞C', orb: '365 Days' }, atmos: { active: true, color: 'rgba(50, 150, 255, 0.3)', composition: '78% N2, 21% O2' }, comp: { g: 1.0, mass: 1.0, dia: 1.0 }, details: "Our home." },
    mars: { id: 'mars', name: 'Mars', type: 'Terrestrial', visualRadius: 7, realRadius: 0.24, color: '#E15F41', texture: 'rocky', parent: 'sun', orbit: { r: 190, speed: 0.9, angle: Math.random()*6 }, stats: { dia: '6,779 km', day: '24.6 Hours', temp: '-63¬∞C', orb: '687 Days' }, atmos: { active: true, color: 'rgba(255, 100, 50, 0.2)', composition: '95.3% CO2' }, comp: { g: 0.38, mass: 0.107, dia: 0.53 }, details: "Red Planet." },
    jupiter: { id: 'jupiter', name: 'Jupiter', type: 'Gas Giant', visualRadius: 28, realRadius: 4.8, color: '#E0CA93', texture: 'banded', parent: 'sun', orbit: { r: 320, speed: 0.5, angle: Math.random()*6 }, stats: { dia: '139,820 km', day: '10 Hours', temp: '-108¬∞C', orb: '12 Years' }, atmos: { active: true, color: 'rgba(200, 180, 140, 0.1)', composition: '90% Hydrogen' }, comp: { g: 2.4, mass: 317.8, dia: 11.2 }, details: "Largest planet." },
    saturn: { id: 'saturn', name: 'Saturn', type: 'Gas Giant', visualRadius: 24, realRadius: 4.0, color: '#F4D03F', texture: 'banded', rings: true, parent: 'sun', orbit: { r: 450, speed: 0.35, angle: Math.random()*6 }, stats: { dia: '116,460 km', day: '10.7 Hours', temp: '-139¬∞C', orb: '29 Years' }, atmos: { active: true, color: 'rgba(220, 200, 150, 0.1)', composition: '96% Hydrogen' }, comp: { g: 1.065, mass: 95.2, dia: 9.45 }, details: "Ringed beauty." },
    uranus: { id: 'uranus', name: 'Uranus', type: 'Ice Giant', visualRadius: 16, realRadius: 1.8, color: '#74B9FF', texture: 'atmosphere', parent: 'sun', orbit: { r: 560, speed: 0.2, angle: Math.random()*6 }, stats: { dia: '50,724 km', day: '17 Hours', temp: '-197¬∞C', orb: '84 Years' }, atmos: { active: true, color: 'rgba(100, 200, 255, 0.1)', composition: '83% Hydrogen' }, comp: { g: 0.886, mass: 14.5, dia: 4.0 }, details: "Ice Giant." },
    neptune: { id: 'neptune', name: 'Neptune', type: 'Ice Giant', visualRadius: 15, realRadius: 1.7, color: '#0984E3', texture: 'atmosphere', parent: 'sun', orbit: { r: 680, speed: 0.15, angle: Math.random()*6 }, stats: { dia: '49,244 km', day: '16 Hours', temp: '-201¬∞C', orb: '165 Years' }, atmos: { active: true, color: 'rgba(50, 100, 200, 0.1)', composition: '80% Hydrogen' }, comp: { g: 1.137, mass: 17.1, dia: 3.88 }, details: "Windy." },
    pluto: { id: 'pluto', name: 'Pluto', type: 'Dwarf Planet', visualRadius: 4, realRadius: 0.08, color: '#D6A2E8', texture:'rocky', parent:'sun', orbit:{r:780, speed:0.1, angle:0}, stats:{dia:'2,376 km', day:'153h', temp:'-230C', orb:'248y'}, atmos:{active:true, color:'rgba(100,50,100,0.2)', composition:'Thin N2'}, comp:{g:0.06, mass:0.002, dia:0.18}, details:"Famous dwarf." },
    moon: { id: 'moon', name: 'The Moon', type: 'Satellite', visualRadius: 2.5, realRadius: 0.12, color: '#CCC', texture:'rocky', parent: 'earth', orbit:{r:25, speed:3, angle:0}, stats:{dia:'3,474 km'}, atmos:{active:false, composition:'None'}, comp:{g:0.162,mass:0.012,dia:0.27}, details:"Our satellite." }
};

const TRAPPIST_DATA = {
    trap1: { id: 'trap1', name: 'Trappist-1', type: 'Red Dwarf', visualRadius: 20, realRadius: 15, color: '#FF4136', glow: '#85144b', texture: 'star', parent: null, orbit: { r: 0, speed: 0 }, stats: { dia: '109,400 km', day: '20 Days', temp: '2,430¬∞C', orb: 'N/A' }, atmos: { active: false, color: 'transparent', composition: 'Hydrogen/Helium' }, comp: { g: 0.92, mass: 0.089, dia: 0.117 }, details: "Ultracool dwarf star." },
    trapb: { id: 'trapb', name: 'Trappist-1b', type: 'Terrestrial', visualRadius: 7, realRadius: 1.0, color: '#A52A2A', texture: 'rocky', parent: 'trap1', orbit: { r: 60, speed: 3.0, angle: Math.random()*6 }, stats: { dia: '12,742 km', day: '1.5 Days', temp: '1,227¬∞C', orb: '1.5 Days' }, atmos: { active: false, color: 'transparent', composition: 'Unknown' }, comp: { g: 1.1, mass: 1.3, dia: 1.1 }, details: "Closest planet. Hot." },
    trapc: { id: 'trapc', name: 'Trappist-1c', type: 'Terrestrial', visualRadius: 7.5, realRadius: 1.1, color: '#8B4513', texture: 'rocky', parent: 'trap1', orbit: { r: 80, speed: 2.5, angle: Math.random()*6 }, stats: { dia: '13,816 km', day: '2.4 Days', temp: '756¬∞C', orb: '2.4 Days' }, atmos: { active: false, color: 'transparent', composition: 'Unknown' }, comp: { g: 1.3, mass: 1.3, dia: 1.1 }, details: "Very hot." },
    trapd: { id: 'trapd', name: 'Trappist-1d', type: 'Terrestrial', visualRadius: 7.2, realRadius: 0.78, color: '#22A6B3', texture: 'earth', parent: 'trap1', orbit: { r: 105, speed: 2.0, angle: Math.random()*6 }, stats: { dia: '9,938 km', day: '4.0 Days', temp: '67¬∞C', orb: '4.0 Days' }, atmos: { active: true, color: 'rgba(50, 150, 255, 0.3)', composition: 'Unknown' }, comp: { g: 0.69, mass: 0.41, dia: 0.78 }, details: "Potential habitability?" },
    trape: { id: 'trape', name: 'Trappist-1e', type: 'Terrestrial', visualRadius: 7.5, realRadius: 0.91, color: '#2ecc71', texture: 'earth', parent: 'trap1', orbit: { r: 135, speed: 1.6, angle: Math.random()*6 }, stats: { dia: '11,595 km', day: '6.1 Days', temp: '-20¬∞C', orb: '6.1 Days' }, atmos: { active: true, color: 'rgba(100, 255, 100, 0.3)', composition: 'Unknown' }, comp: { g: 0.93, mass: 0.62, dia: 0.91 }, details: "Habitable Zone." },
    trapf: { id: 'trapf', name: 'Trappist-1f', type: 'Terrestrial', visualRadius: 8.0, realRadius: 1.04, color: '#88CCFF', texture: 'ice', parent: 'trap1', orbit: { r: 170, speed: 1.2, angle: Math.random()*6 }, stats: { dia: '13,251 km', day: '9.2 Days', temp: '-54¬∞C', orb: '9.2 Days' }, atmos: { active: true, color: 'rgba(150, 200, 255, 0.4)', composition: 'Unknown' }, comp: { g: 1.2, mass: 0.68, dia: 1.04 }, details: "Ice world." },
    trapg: { id: 'trapg', name: 'Trappist-1g', type: 'Terrestrial', visualRadius: 8.5, realRadius: 1.13, color: '#74B9FF', texture: 'ice', parent: 'trap1', orbit: { r: 210, speed: 0.9, angle: Math.random()*6 }, stats: { dia: '14,398 km', day: '12.4 Days', temp: '-73¬∞C', orb: '12.4 Days' }, atmos: { active: true, color: 'rgba(100, 150, 255, 0.5)', composition: 'Unknown' }, comp: { g: 1.3, mass: 1.34, dia: 1.13 }, details: "Large icy world." },
    traph: { id: 'traph', name: 'Trappist-1h', type: 'Terrestrial', visualRadius: 6.0, realRadius: 0.76, color: '#CCCCCC', texture: 'rocky', parent: 'trap1', orbit: { r: 250, speed: 0.7, angle: Math.random()*6 }, stats: { dia: '9,684 km', day: '20 Days', temp: '-113¬∞C', orb: '20 Days' }, atmos: { active: false, color: 'transparent', composition: 'Unknown' }, comp: { g: 0.75, mass: 0.33, dia: 0.76 }, details: "Outermost." }
};

let DATA = SOLAR_DATA;

// --- 3. HELPER FUNCTIONS ---
function getSystemStarId() {
    return Object.keys(DATA).find(id => DATA[id].parent === null);
}

// --- 4. ONBOARDING CONTROLLER ---
const onboarding = {
    step: 0,
    steps: [ 
        { title: "Navigation", desc: "Click and drag to rotate. Scroll to zoom. Use 'Time' slider to control speed.", highlight: null },
        { title: "System Switching", desc: "Use the dropdown to instantly swap between the Solar System and the Trappist-1 Exoplanet System.", highlight: "system-select" },
        { title: "Teacher Mode", desc: "Switch to 'Teacher Mode' to visualize orbit trails and simplify the UI for presentation.", highlight: "mode-select" }
    ],
    
    check: function() {
        if(!localStorage.getItem('cosmos_visited')) document.getElementById('onboarding').classList.add('active');
    },
    
    next: function() {
        this.step++;
        if(this.step >= this.steps.length) { this.close(); return; }
        const data = this.steps[this.step];
        document.getElementById('ob-step-num').innerText = `${this.step + 1}/${this.steps.length}`;
        document.getElementById('ob-title').innerText = data.title;
        document.getElementById('ob-desc').innerHTML = data.desc + (data.highlight ? `<br><br><div class="highlight-box">${data.highlight}</div>` : '');
    },
    
    close: function() {
        document.getElementById('onboarding').classList.remove('active');
        localStorage.setItem('cosmos_visited', 'true');
        audioManager.init();
    }
};

// --- 5. CORE ENGINE & CANVAS MANAGER ---
const canvas = document.getElementById('cosmos');
const ctx = canvas.getContext('2d');
let W, H;

function resize() {
    W = window.innerWidth;
    H = window.innerHeight;
    const dpr = window.devicePixelRatio || 1;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpr, dpr);
}
window.addEventListener('resize', resize);
resize();

let time = 0;
let timeSpeed = 0.2; 
let isRealScale = false; 
let showGoldilocks = false;
let showGravityWell = false;
let showProbes = false;
let isTeacherMode = false;
let showTrails = false;
let orbitHistory = {}; 

// Camera
const cam = {
    targetId: 'sun',
    x: 0, y: 0, z: 0, 
    dist: 600,
    theta: -0.4, 
    phi: 1.5, 
    dest: { x:0, y:0, z:0, dist: 600 },
    
    reset: () => { 
        cam.focus(getSystemStarId()); 
    },
    zoomIn: () => { cam.dest.dist = Math.max(20, cam.dest.dist * 0.7); },
    zoomOut: () => { cam.dest.dist = Math.min(2000, cam.dest.dist * 1.3); },
    focus: (id) => {
        if(!DATA[id]) return;
        cam.targetId = id;
        const obj = DATA[id];
        let targetDist = 600;
        if(obj.type.includes('Star')) targetDist = 600;
        else if(obj.type.includes('Giant')) targetDist = 200;
        else targetDist = 100;
        if(isRealScale && !obj.type.includes('Star')) targetDist = 30;
        cam.dest.dist = targetDist;
        ui.updateBreadcrumbs(id);
        ui.highlightNav(id);
        if(!ui.sidebarOpen) ui.openSidebar(id);
    }
};

// --- 6. SIMULATION CONTROL ---
const sim = {
    toggleScale: () => {
        isRealScale = !isRealScale;
        document.getElementById('btn-scale').innerText = isRealScale ? "Scale: REAL" : "Scale: Visual";
        document.getElementById('btn-scale').classList.toggle('active', isRealScale);
    },
    toggleGoldilocks: () => {
        showGoldilocks = !showGoldilocks;
        document.getElementById('btn-zone').classList.toggle('active', showGoldilocks);
    },
    toggleGravityWell: () => {
        showGravityWell = !showGravityWell;
        document.getElementById('btn-well').classList.toggle('active', showGravityWell);
    },
    toggleProbes: () => {
        showProbes = !showProbes;
        document.getElementById('btn-probe').classList.toggle('active', showProbes);
    },
    setTimeScale: (val) => {
        timeSpeed = val / 100;
    },
    toggleTeacherMode: (mode) => {
        isTeacherMode = (mode === 'teacher');
        showTrails = isTeacherMode; 
        document.body.classList.toggle('teacher-mode', isTeacherMode);
        if(isTeacherMode) {
            orbitHistory = {}; 
        }
    }
};

// --- 7. SYSTEM MANAGER (PATCHED) ---
const systemManager = {
    load: (sys) => {
        // 1. Switch Data
        DATA = sys === 'trappist' ? TRAPPIST_DATA : SOLAR_DATA;
        
        // 2. Hard Reset State
        orbitHistory = {};
        time = 0;
        objects = {};
        particles = [];
        probes = [];
        
        // 3. Rebuild Background
        for(let i=0; i<200; i++) {
            particles.push({ 
                type:'star', 
                x:Math.random()*2000-1000, 
                y:Math.random()*1000-500, 
                z:Math.random()*2000-1000, 
                size: Math.random()*1.5 
            });
        }
        
        // 4. System Specifics (Probes only for Solar)
        if(sys === 'solar') {
            probes.push({ id: 'v1', name: 'Voyager 1', x: 850, y:0, z: 0, r: 600, angle: 0.5, speed: 0.05, color: '#fff' });
            probes.push({ id: 'v2', name: 'Voyager 2', x: -650, y:0, z: 400, r: 550, angle: 2.5, speed: 0.04, color: '#fff' });
        }

        // 5. Rebuild 3D Objects
        const newIds = Object.keys(DATA);
        newIds.forEach(k => {
            objects[k] = { 
                ...DATA[k], 
                x:0, y:0, z:0, sx:0, sy:0, scale:1, currentRadius: DATA[k].visualRadius 
            };
        });

        // 6. Camera Reset
        const firstId = getSystemStarId(); 
        cam.targetId = firstId;
        cam.x = 0; cam.y = 0; cam.z = 0; 
        cam.dest = { x:0, y:0, z:0, dist: 600 };
        
        // --- MINIMAL PATCH (Trappist Context Awareness) ---
        if (sys === 'trappist') {
            cam.dist = 250;       // FIX #1: Much closer default
            cam.dest.dist = 250;
            isRealScale = false;  // FIX #5: Prevent invisibility
            document.getElementById('btn-scale').innerText = "Scale: Visual";
            time += 50;          // FIX #4: Warm-up orbits for trails
        }

        // 7. UI Updates
        document.getElementById('breadcrumbs').innerText = sys === 'trappist' ? "Trappist-1 System" : "Solar System";
        ui.rebuildNav();
        ui.populateData(firstId); 
        gravityLab.select(firstId);
        
        // 8. Refresh Lab Data
        if(lab.isActive) lab.init();
    }
};

// --- 8. RENDER LOOP (Fixed RAF) ---
function loop() {
    if(!lab.isActive) {
        simUpdate();
        renderScene();
        mainRAF = requestAnimationFrame(loop);
    }
}

function simUpdate() {
    time += timeSpeed;
    
    // History for trails (Teacher Mode)
    if(showTrails) {
        for(let k in objects) {
            const o = objects[k];
            if(!orbitHistory[k]) orbitHistory[k] = [];
            if(!o.parent && orbitHistory[k].length > 100) orbitHistory[k].shift();
            if(Math.abs(timeSpeed) > 0.01) {
                if(!orbitHistory[k].length || 
                   Math.abs(o.x - orbitHistory[k][orbitHistory[k].length-1].x) + Math.abs(o.z - orbitHistory[k][orbitHistory[k].length-1].z) > 2) {
                    orbitHistory[k].push({x: o.x, z: o.z});
                }
            }
        }
    }

    for(let k in objects) {
        const o = objects[k];
        const targetR = isRealScale ? o.realRadius : o.visualRadius;
        o.currentRadius += (targetR - o.currentRadius) * 0.05;
        if(o.parent) {
            const angle = o.orbit.angle + (time * o.orbit.speed * 0.01);
            o.lx = Math.cos(angle) * o.orbit.r;
            o.lz = Math.sin(angle) * o.orbit.r;
            o.ly = 0;
            const p = objects[o.parent];
            o.x = p.x + o.lx;
            o.y = p.y + o.ly;
            o.z = p.z + o.lz;
        } else {
            o.x = 0; o.y = 0; o.z = 0;
        }
    }
    
    const targetObj = objects[cam.targetId];
    if(targetObj) {
        cam.dest.x = targetObj.x;
        cam.dest.y = targetObj.y;
        cam.dest.z = targetObj.z;
    }
    cam.x += (cam.dest.x - cam.x) * 0.1;
    cam.y += (cam.dest.y - cam.y) * 0.1;
    cam.z += (cam.dest.z - cam.z) * 0.1;
    cam.dist += (cam.dest.dist - cam.dist) * 0.1;
    
    checkAtmosphere();
}

function checkAtmosphere() {
    const target = DATA[cam.targetId];
    const overlay = document.getElementById('atmos-overlay');
    const astro = document.getElementById('astro-marker');
    
    if(target && target.atmos && target.atmos.active && cam.dist < target.visualRadius * 5) {
        const intensity = 1 - (cam.dist / (target.visualRadius * 5));
        overlay.style.backgroundColor = target.atmos.color;
        overlay.style.opacity = intensity;
        ui.updateStats(true);
    } else {
        overlay.style.opacity = 0;
        ui.updateStats(false);
    }

    if(cam.dist < 50 && !isRealScale) {
        astro.style.display = 'block';
        astro.style.left = (W/2) + 'px';
        astro.style.top = (H/2) + 'px';
    } else {
        astro.style.display = 'none';
    }
}

function renderScene() {
    ctx.fillStyle = '#020204';
    ctx.fillRect(0, 0, W, H);
    const cx = cam.x + cam.dist * Math.cos(cam.theta) * Math.sin(cam.phi);
    const cy = cam.y + cam.dist * Math.sin(cam.theta);
    const cz = cam.z + cam.dist * Math.cos(cam.theta) * Math.cos(cam.phi);
    
    if(showProbes) {
        probes.forEach(p => {
            p.angle += p.speed * timeSpeed * 0.005;
            p.x = Math.cos(p.angle) * p.r;
            p.z = Math.sin(p.angle) * p.r;
            const proj = project3D(p.x, p.y, p.z, cx, cy, cz);
            if(proj.visible) {
                ctx.fillStyle = 'white';
                ctx.font = '10px monospace';
                ctx.fillText(p.name, proj.x + 10, proj.y);
                ctx.beginPath(); ctx.arc(proj.x, proj.y, 2, 0, 6.28); ctx.fill();
            }
        });
    }

    if(showGravityWell) drawGravityWells(cx, cy, cz);

    if(showGoldilocks) {
        const proj = project3D(0,0,0, cx,cy,cz);
        if(proj.visible) {
            // FIX #3: Tighter Habitable Zone for Red Dwarfs (Visual * 2 instead of 4)
            const starId = getSystemStarId();
            const starData = DATA[starId];
            const scale = proj.scale * (starData.visualRadius * 2);
            
            const g = ctx.createRadialGradient(proj.x, proj.y, scale*0.7, proj.x, proj.y, scale*1.3);
            g.addColorStop(0, 'rgba(0, 255, 100, 0)');
            g.addColorStop(0.5, 'rgba(0, 255, 100, 0.05)');
            g.addColorStop(1, 'rgba(0, 255, 100, 0)');
            ctx.fillStyle = g;
            ctx.beginPath(); ctx.arc(proj.x, proj.y, scale*1.5, 0, 6.28); ctx.fill();
        }
    }

    const renderList = [];
    particles.forEach(p => {
        if(p.type === 'star') {
            const proj = project3D(p.x, p.y, p.z, cx,cy,cz);
            if(proj.visible) {
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.beginPath(); ctx.arc(proj.x, proj.y, p.size, 0, 6.28); ctx.fill();
            }
        }
    });

    // Draw Trails first (Teacher Mode)
    if(showTrails) {
        ctx.lineWidth = 1;
        for(let k in orbitHistory) {
            if(orbitHistory[k].length < 2) continue;
            const obj = DATA[k];
            ctx.strokeStyle = obj.color;
            ctx.globalAlpha = 0.3;
            ctx.beginPath();
            const pStart = project3D(orbitHistory[k][0].x, 0, orbitHistory[k][0].z, cx, cy, cz);
            if(pStart.visible) ctx.moveTo(pStart.x, pStart.y);
            
            for(let i=1; i<orbitHistory[k].length; i++) {
                const p = project3D(orbitHistory[k][i].x, 0, orbitHistory[k][i].z, cx, cy, cz);
                if(p.visible) ctx.lineTo(p.x, p.y);
            }
            ctx.stroke();
            ctx.globalAlpha = 1;
        }
    }

    for(let k in objects) {
        const o = objects[k];
        const proj = project3D(o.x, o.y, o.z, cx, cy, cz);
        if(proj.visible) {
            o.sx = proj.x; o.sy = proj.y; o.scale = proj.scale; o.depth = proj.d;
            renderList.push({ type:'body', data:o, depth: proj.d });
        }
    }
    renderList.sort((a,b) => b.depth - a.depth);
    renderList.forEach(item => { drawBody(item.data, cx, cy, cz); });
}

function drawGravityWells(cx, cy, cz) {
    ctx.strokeStyle = 'rgba(0, 240, 255, 0.1)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    const size = 1000; const step = 200;
    for(let i=-size; i<=size; i+=step) {
        let p1 = project3D(i, 0, -size, cx,cy,cz);
        let p2 = project3D(i, 0, size, cx,cy,cz);
        if(p1.visible && p2.visible) { ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); }
        p1 = project3D(-size, 0, i, cx,cy,cz);
        p2 = project3D(size, 0, i, cx,cy,cz);
        if(p1.visible && p2.visible) { ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); }
    }
    ctx.stroke();
    const sunProj = project3D(0,0,0,cx,cy,cz);
    if(sunProj.visible) {
        const r = 100 * sunProj.scale;
        const g = ctx.createRadialGradient(sunProj.x, sunProj.y, r, sunProj.x, sunProj.y, r*10);
        g.addColorStop(0, 'rgba(0, 240, 255, 0.2)');
        g.addColorStop(1, 'transparent');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(sunProj.x, sunProj.y, r*10, 0, 6.28); ctx.fill();
    }
}

function project3D(x, y, z, cx, cy, cz) {
    const dx = x - cx;
    const dy = y - cy;
    const dz = z - cz;
    const x1 = dx * Math.cos(-cam.phi) - dz * Math.sin(-cam.phi);
    const z1 = dx * Math.sin(-cam.phi) + dz * Math.cos(-cam.phi);
    const y2 = dy * Math.cos(-cam.theta) - z1 * Math.sin(-cam.theta);
    const z2 = dy * Math.sin(-cam.theta) + z1 * Math.cos(-cam.theta);
    const fov = 1000;
    if(z2 > 1) {
        const scale = fov / z2;
        return { x: (W/2) + x1 * scale, y: (H/2) + y2 * scale, scale: scale, d: z2, visible: true };
    }
    return { visible: false };
}

function drawBody(o, cx, cy, cz) {
    const r = Math.max(1, o.currentRadius * o.scale);
    if(o.glow) {
        const g = ctx.createRadialGradient(o.sx, o.sy, r, o.sx, o.sy, r*4);
        g.addColorStop(0, o.glow); g.addColorStop(1, 'transparent');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(o.sx, o.sy, r*4, 0, 6.28); ctx.fill();
    }
    ctx.save();
    ctx.beginPath(); ctx.arc(o.sx, o.sy, r, 0, 6.28); ctx.clip();
    ctx.fillStyle = o.color; ctx.fill();
    if(o.texture === 'banded') {
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        for(let i=0; i<4; i++) ctx.fillRect(o.sx - r, o.sy + (i*r/2)-r, r*2, r/4);
    } else if (o.texture === 'earth') {
        ctx.fillStyle = '#27ae60'; ctx.globalAlpha=0.6;
        ctx.beginPath(); ctx.arc(o.sx-r*0.3, o.sy-r*0.2, r*0.5, 0, 6.28); ctx.fill();
    }
    const grad = ctx.createRadialGradient(o.sx - r*0.4, o.sy - r*0.4, 0, o.sx, o.sy, r);
    grad.addColorStop(0, 'rgba(0,0,0,0)');
    grad.addColorStop(0.8, 'rgba(0,0,0,0.1)');
    grad.addColorStop(1, 'rgba(0,0,0,0.9)');
    ctx.fillStyle = grad;
    ctx.fillRect(o.sx - r, o.sy - r, r*2, r*2);
    ctx.restore();
    if(o.rings) {
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(200,180,140,0.4)';
        ctx.lineWidth = r * 0.4;
        ctx.ellipse(o.sx, o.sy, r*2.0, r*0.6, -0.2, 0, 6.28);
        ctx.stroke();
    }
    if(o.scale > 0.5 || o.id === cam.targetId) {
        ctx.fillStyle = o.id === cam.targetId ? '#00F0FF' : '#666';
        ctx.font = '10px Segoe UI';
        ctx.fillText(o.name, o.sx, o.sy + r + 15);
    }
}

// --- 9. UI CONTROLLER ---
const ui = {
    sidebarOpen: false,
    init: () => {
        ui.rebuildNav();
        window.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const brandBtn = document.querySelector('.brand'); 
            if (ui.sidebarOpen && !sidebar.contains(e.target) && !brandBtn.contains(e.target) && !e.target.classList.contains('nav-chip')) {
                ui.closeSidebar();
            }
        });
    },
    rebuildNav: () => {
        const nav = document.getElementById('nav-rail');
        nav.innerHTML = '';
        const starId = getSystemStarId();
        const keys = Object.keys(DATA).filter(k => !DATA[k].parent || DATA[k].parent === starId);
        keys.forEach(id => {
            const btn = document.createElement('div');
            btn.className = 'nav-chip';
            btn.id = 'nav-'+id;
            btn.innerHTML = `<div class="color-dot" style="background:${DATA[id].color}"></div>${DATA[id].name}`;
            btn.onclick = (e) => { e.stopPropagation(); cam.focus(id); };
            nav.appendChild(btn);
        });
    },
    toggleSidebar: () => {
        if(ui.sidebarOpen) ui.closeSidebar();
        else ui.openSidebar(cam.targetId);
    },
    openSidebar: (id) => {
        ui.sidebarOpen = true;
        document.getElementById('sidebar').classList.add('active');
        ui.populateData(id);
        gravityLab.select(id);
    },
    closeSidebar: () => {
        ui.sidebarOpen = false;
        document.getElementById('sidebar').classList.remove('active');
    },
    populateData: (id) => {
        const o = DATA[id];
        if(!o) return;
        document.getElementById('info-name').innerText = o.name;
        document.getElementById('info-type').innerText = o.type;
        document.getElementById('info-desc').innerText = o.details || "";
        ui.updateStats(false);
        gravityLab.select(id);
    },
    updateStats: (showAtmos) => {
        const o = DATA[cam.targetId];
        if(!o) return;
        const container = document.getElementById('dynamic-stats');
        container.innerHTML = '';
        if(showAtmos && o.atmos && o.atmos.composition) {
            const row = document.createElement('div');
            row.className = 'stat-item'; row.style.gridColumn = 'span 2';
            row.innerHTML = `<h4 style="color:var(--accent)">Composition</h4><p style="font-size:0.85rem; color:#fff">${o.atmos.composition}</p>`;
            container.appendChild(row);
            container.innerHTML += `<div class="stat-item"><h4>Pressure</h4><p>${o.id==='earth'?'1 atm':'High'}</p></div><div class="stat-item"><h4>Wind</h4><p>${o.id==='neptune'?'Supersonic':'Variable'}</p></div>`;
        } else {
            container.innerHTML = `<div class="stat-item"><h4>Diameter</h4><p>${o.stats.dia}</p></div><div class="stat-item"><h4>Day Length</h4><p>${o.stats.day}</p></div><div class="stat-item"><h4>Avg Temp</h4><p>${o.stats.temp}</p></div><div class="stat-item"><h4>Gravity</h4><p>${o.comp.g}g</p></div>`;
        }
    },
    updateBreadcrumbs: (id) => {
        const bc = document.getElementById('breadcrumbs');
        const starId = getSystemStarId();
        let html = '';
        
        // FIX #2: Clearer labeling for Trappist
        if (starId === 'trap1') {
            html = `<span onclick="cam.focus('trap1')">Trappist-1 System (7 Exoplanets)</span>`;
        } else {
            html = `<span onclick="cam.focus('sun')">Solar System</span>`;
        }
        
        const o = DATA[id];
        if(o.parent && o.parent !== starId) {
            html += ` > <span onclick="cam.focus('${o.parent}')">${DATA[o.parent].name}</span>`;
        }
        if(id !== starId) html += ` > <span>${o.name}</span>`;
        bc.innerHTML = html;
    },
    highlightNav: (id) => {
        document.querySelectorAll('.nav-chip').forEach(c => c.classList.remove('active'));
        const el = document.getElementById('nav-'+id);
        if(el) { el.classList.add('active'); el.scrollIntoView({behavior:'smooth',inline:'center'}); }
    }
};

// --- 10. GRAVITY JUMP LAB (REAL PHYSICS) ---
const gravityLab = {
    currentG: 1.0,
    currentId: 'earth',
    jumping: false,
    
    init: () => {
        this.canvas = document.getElementById('jump-canvas');
        this.c = this.canvas.getContext('2d');
        this.resize();
        new ResizeObserver(() => gravityLab.resize()).observe(this.canvas.parentElement);
        this.loop();
    },

    resize: () => {
        const c = gravityLab.c;
        const canvas = gravityLab.canvas;
        const parent = canvas.parentElement;
        if(!parent) return;
        
        const w = parent.clientWidth;
        const h = parent.clientHeight; 
        const dpr = window.devicePixelRatio || 1;
        
        canvas.width = w * dpr;
        canvas.height = h * dpr;
        c.setTransform(1, 0, 0, 1, 0, 0); 
        c.scale(dpr, dpr);
    },
    
    select: (id) => {
        const o = DATA[id];
        if(!o) return;
        gravityLab.currentG = o.comp.g;
        gravityLab.currentId = id;
        document.getElementById('jump-readout').innerText = `Gravity: ${o.comp.g}g (Earth=1.0)`;
    },
    
    run: () => {
        if (gravityLab.jumping) return;
        gravityLab.jumping = true;

        const g = gravityLab.currentG * 9.81; // real gravity (m/s^2)
        const jumpVelocity = 3; // m/s (human vertical jump)
        // Max Height = v^2 / 2g
        
        let t = 0;
        const dt = 0.05; 

        const animate = () => {
            const yMeters = jumpVelocity * t - 0.5 * g * t * t;
            const y = 80 - yMeters * 60; // meter ‚Üí pixel scale

            gravityLab.draw(y);

            // Stop when we hit the ground (y returns to 80 or goes higher)
            if (y >= 80) { 
                gravityLab.jumping = false; 
                return; 
            }
            t += dt;
            requestAnimationFrame(animate);
        };
        animate();
    },
    
    draw: (y) => {
        const c = gravityLab.c;
        const w = gravityLab.canvas.width / (window.devicePixelRatio || 1); 
        const h = gravityLab.canvas.height / (window.devicePixelRatio || 1);
        
        c.clearRect(0,0, w, h);
        c.strokeStyle = '#444';
        c.beginPath(); c.moveTo(10,80); c.lineTo(w-10,80); c.stroke();
        
        const centerX = w/2;
        
        c.strokeStyle = 'white';
        c.lineWidth = 2;
        c.beginPath();
        c.arc(centerX, y-10, 5, 0, 6.28);
        c.moveTo(centerX, y-5); c.lineTo(centerX, y+10);
        if(y < 75) {
            c.lineTo(centerX-10, y+20); c.lineTo(centerX-10, y+20);
            c.moveTo(centerX, y+10); c.lineTo(centerX+10, y+20);
        } else {
            c.lineTo(centerX-5, y+20); c.lineTo(centerX-5, y+20);
            c.moveTo(centerX, y+10); c.lineTo(centerX+5, y+20);
        }
        c.stroke();
    },
    
    loop: () => {
        if(!gravityLab.jumping) gravityLab.draw(80);
        requestAnimationFrame(gravityLab.loop);
    }
};

// --- 11. LAB ENGINE (Untouched) ---
const lab = {
    isActive: false,
    mode: 'split',
    rotation: { 1: 0, 2: 0 },
    rafId: null,
    dragActive: false,
    
    init: () => {
        const s1 = document.getElementById('lab-select-1');
        const s2 = document.getElementById('lab-select-2');
        s1.innerHTML = ''; s2.innerHTML = '';
        const keys = Object.keys(DATA).sort((a,b) => DATA[b].visualRadius - DATA[a].visualRadius); 
        keys.forEach(k => {
            const opt1 = document.createElement('option'); opt1.value = k; opt1.innerText = DATA[k].name;
            const opt2 = document.createElement('option'); opt2.value = k; opt2.innerText = DATA[k].name;
            s1.appendChild(opt1);
            s2.appendChild(opt2);
        });
        if(DATA['earth']) s2.value = 'earth'; 

        ['1','2'].forEach(id => {
            const wrap = document.getElementById(`wrapper-${id}`);
            const resizeObserver = new ResizeObserver(() => { if(lab.isActive) lab.refresh(); });
            resizeObserver.observe(wrap);
            
            let isDrag = false, lastX;
            wrap.addEventListener('mousedown', e=>{ 
                isDrag=true; lastX=e.clientX; 
                lab.dragActive = true;
                if(!lab.rafId) lab.loop(); 
            });
            window.addEventListener('mouseup', ()=>{ 
                isDrag=false; 
                lab.dragActive = false; 
            });
            wrap.addEventListener('mousemove', e=>{
                if(isDrag) {
                    const dx = e.clientX - lastX;
                    lab.rotation[id] += dx * 0.005;
                    lastX = e.clientX;
                    if(!lab.rafId) lab.loop();
                }
            });
        });
    },
    
    toggle: () => {
        lab.isActive = !lab.isActive;
        const ov = document.getElementById('lab-overlay');
        if(lab.isActive) {
            ov.classList.add('active');
            lab.refresh();
            if (mainRAF) cancelAnimationFrame(mainRAF);
            mainRAF = null;
        } else {
            ov.classList.remove('active');
            if (!mainRAF) loop();
        }
    },

    setMode: (mode) => {
        lab.mode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`mode-${mode}`).classList.add('active');
        const vp2 = document.querySelector('.lab-viewport:nth-child(2)');
        if(mode === 'stack') vp2.style.display = 'none';
        else vp2.style.display = 'flex';
        lab.refresh();
    },

    refresh: () => {
        if(!lab.isActive) return;
        lab.render();
        if(!lab.dragActive) {
             if(lab.rafId) { cancelAnimationFrame(lab.rafId); lab.rafId = null; }
        }
    },

    loop: () => {
        if(lab.isActive && lab.dragActive) {
            lab.render();
            lab.rafId = requestAnimationFrame(lab.loop);
        } else {
            lab.rafId = null;
        }
    },

    render: () => {
        const id1 = document.getElementById('lab-select-1').value;
        const id2 = document.getElementById('lab-select-2').value;
        const o1 = DATA[id1];
        const o2 = DATA[id2];

        if(lab.mode === 'split') {
            lab.drawPlanet('1', o1);
            lab.drawPlanet('2', o2);
        } else {
            lab.drawPlanet('1', o1); 
            const cvs = document.getElementById('lab-canvas-1');
            const cx = cvs.getContext('2d');
            const wrapper = document.getElementById('wrapper-1');
            
            const maxR = Math.max(o1.visualRadius, o2.visualRadius);
            const scale = (Math.min(wrapper.clientWidth, wrapper.clientHeight) * 0.35) / maxR;
            const r2 = o2.visualRadius * scale;
            
            const w = wrapper.clientWidth * window.devicePixelRatio;
            const h = wrapper.clientHeight * window.devicePixelRatio;
            
            cx.save();
            cx.translate(w/2, h/2);
            cx.shadowColor = 'black';
            cx.shadowBlur = 10;
            cx.fillStyle = o2.color;
            cx.beginPath(); 
            cx.arc(0, 0, r2, 0, 6.28); 
            cx.fill();
            cx.restore();
            
            cx.fillStyle = 'white';
            cx.font = '10px Segoe UI';
            cx.textAlign = 'center';
            cx.fillText(o2.name, w/2, h/2 + r2/window.devicePixelRatio + 15);
        }
        lab.updateDashboard(id1, id2);
    },

    drawPlanet: (canvasId, obj) => {
        const cvs = document.getElementById(`lab-canvas-${canvasId}`);
        const cx = cvs.getContext('2d');
        const wrapper = document.getElementById(`wrapper-${canvasId}`);
        
        const w = wrapper.clientWidth;
        const h = wrapper.clientHeight;
        const dpr = window.devicePixelRatio || 1;

        cvs.width = w * dpr;
        cvs.height = h * dpr;
        cx.setTransform(1, 0, 0, 1, 0, 0); 
        cx.scale(dpr, dpr);
        
        cx.clearRect(0,0,w,h);
        const r = Math.min(w, h) * 0.35 * (obj.visualRadius / 40); 
        
        cx.save();
        cx.translate(w/2, h/2);
        
        if(obj.rings) {
            cx.beginPath(); cx.strokeStyle = 'rgba(200,180,140,0.3)'; cx.lineWidth = r*0.4;
            cx.rotate(-0.2); cx.ellipse(0,0,r*2.2,r*0.6,0,Math.PI,0); cx.stroke(); cx.rotate(0.2);
        }
        
        cx.beginPath(); cx.arc(0,0,r,0,6.28); cx.clip();
        cx.fillStyle = obj.color; cx.fill();
        
        const rotX = Math.sin(lab.rotation[canvasId]) * r;
        if(obj.texture === 'banded') {
            cx.fillStyle = 'rgba(0,0,0,0.2)';
            for(let i=-1; i<=1; i++) cx.fillRect(-r, (i*r/3)-r, r*2, r/4);
        } else if (obj.texture === 'earth') {
            cx.fillStyle = '#2ecc71'; cx.globalAlpha=0.7;
            cx.beginPath(); cx.arc(rotX*0.5, -r*0.2, r*0.6, 0, 6.28); cx.fill();
        }
        
        if(obj.atmos && obj.atmos.active) {
            const g = cx.createRadialGradient(0,0,r*0.8,0,0,r*1.1);
            g.addColorStop(0,'transparent'); g.addColorStop(1,obj.atmos.color);
            cx.fillStyle = g; cx.globalCompositeOperation='source-over';
            cx.beginPath(); cx.arc(0,0,r,0,6.28); cx.fill();
        }

        const grad = cx.createRadialGradient(-r*0.3,-r*0.3,0,0,0,r);
        grad.addColorStop(0,'rgba(0,0,0,0)'); grad.addColorStop(1,'rgba(0,0,0,0.8)');
        cx.fillStyle = grad; cx.globalAlpha=1; 
        cx.fillRect(-r,-r,r*2,r*2);
        
        cx.restore();
        
        if(obj.rings) {
            cx.save(); cx.translate(w/2, h/2);
            cx.beginPath(); cx.strokeStyle = 'rgba(200,180,140,0.5)'; cx.lineWidth = r*0.4;
            cx.rotate(-0.2); cx.ellipse(0,0,r*2.2,r*0.6,0,0,Math.PI); cx.stroke();
            cx.restore();
        }
    },

    updateDashboard: (id1, id2) => {
        const o1 = DATA[id1];
        const o2 = DATA[id2];
        const createBar = (label, val1, val2, max) => {
            const p1 = Math.min((val1 / max) * 100, 100);
            const p2 = Math.min((val2 / max) * 100, 100);
            return `
            <div class="stat-row">
                <div class="stat-label">${o1.name}</div>
                <div class="stat-bar-container"><div class="stat-bar" style="width:${p1}%; background:var(--accent)"></div></div>
                <div class="stat-val">${val1}x</div>
            </div>
            <div class="stat-row">
                <div class="stat-label">${o2.name}</div>
                <div class="stat-bar-container"><div class="stat-bar" style="width:${p2}%; background:var(--warning)"></div></div>
                <div class="stat-val">${val2}x</div>
            </div>`;
        };
        document.getElementById('bar-dia').innerHTML = createBar("Diameter", o1.comp.dia, o2.comp.dia, 120);
        document.getElementById('bar-grav').innerHTML = createBar("Gravity", o1.comp.g, o2.comp.g, 30);
        document.getElementById('bar-mass').innerHTML = createBar("Mass", o1.comp.mass, o2.comp.mass, 333000);
    }
};

// --- 12. INPUTS ---
let isDrag = false, lastX, lastY;
canvas.addEventListener('mousedown', e => { isDrag=true; lastX=e.clientX; lastY=e.clientY; });
window.addEventListener('mouseup', () => isDrag=false);
canvas.addEventListener('mousemove', e => {
    if(isDrag) {
        const dx = e.clientX - lastX;
        const dy = e.clientY - lastY;
        cam.phi -= dx * 0.005;
        cam.theta -= dy * 0.005;
        cam.theta = Math.max(-1.5, Math.min(1.5, cam.theta));
        lastX = e.clientX; lastY = e.clientY;
    }
});
canvas.addEventListener('wheel', e => { e.preventDefault(); Math.sign(e.deltaY) > 0 ? cam.zoomOut() : cam.zoomIn(); }, {passive:false});
canvas.addEventListener('touchstart', e => { isDrag=true; lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; });
canvas.addEventListener('touchmove', e => {
    if(isDrag) {
        e.preventDefault();
        const dx = e.touches[0].clientX - lastX;
        const dy = e.touches[0].clientY - lastY;
        cam.phi -= dx * 0.01; cam.theta -= dy * 0.01;
        lastX = e.touches[0].clientX; lastY = e.touches[0].clientY;
    }
}, {passive:false});

// --- 13. INITIALIZATION ---
function init() {
    for(let i=0; i<200; i++) particles.push({ type:'star', x:Math.random()*2000-1000, y:Math.random()*1000-500, z:Math.random()*2000-1000, size: Math.random()*1.5 });
    for(let i=0; i<300; i++) {
        const r = 240 + Math.random() * 40;
        const a = Math.random() * 6.28;
        particles.push({ type:'asteroid', r: r, angle: a, speed: (1/r)*80, y: (Math.random()-0.5)*15 });
    }

    Object.keys(DATA).forEach(k => {
        objects[k] = { ...DATA[k], x:0, y:0, z:0, sx:0, sy:0, scale:1, currentRadius: DATA[k].visualRadius };
    });

    ui.init();
    lab.init();
    gravityLab.init();
    onboarding.check();
    loop();
}

init();
</script>
</body>
</html>